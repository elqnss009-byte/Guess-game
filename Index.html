<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hamoda Guess — لعبة خمن الرقم</title>
  <style>
    :root{
      --bg:#0b1020;--card:#121935;--accent:#7c3aed;--accent2:#22d3ee;--text:#e5e7eb;--muted:#9ca3af;--danger:#ef4444;--success:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:System-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      min-height:100vh;
      background:radial-gradient(1200px 600px at 80% -10%,#1f1147 0%,#0b1020 45%,#040714 100%);
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:center;
      padding:22px;
      position:relative
    }

    /* Giant H watermark */
    .watermark{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      font-size:min(80vw, 80vh);
      font-weight:900;
      color:rgba(124,58,237,0.08);
      z-index:-1;
      pointer-events:none;
      font-family:serif;
    }

    .app{
      width:min(900px,94vw);
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
      backdrop-filter:blur(4px);
      border:1px solid rgba(255,255,255,.05);
      border-radius:24px;
      box-shadow:0 20px 60px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.05);
      overflow:hidden;
      position:relative;
      z-index:1;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    
    header{
      padding:32px 24px 20px;
      text-align:center;
      background:linear-gradient(90deg,rgba(124,58,237,.25),rgba(34,211,238,.25))
    }
    
    .hamoda-title{
      font-size:3.5em;
      font-weight:800;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow:0 0 30px rgba(124,58,237,.6);
      margin:0 0 10px 0;
      letter-spacing:2px;
    }
    
    .game-subtitle{
      font-size:1.8em;
      color:var(--text);
      margin:0 0 20px 0;
      opacity:0.9;
    }
    
    .header-controls{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:20px;
      flex-wrap:wrap;
    }
    
    .control-group{
      display:flex;
      align-items:center;
      gap:10px;
    }

    main{
      padding:24px;
      display:grid;
      gap:18px;
      justify-items:center; /* توسيط كل البانلز */
      width:100%;
    }
    .panel{
      background:var(--card);
      border:1px solid rgba(255,255,255,.06);
      border-radius:20px;
      padding:20px;
      display:grid;
      gap:16px;
      position:relative;
      width:100%;
      max-width:700px; /* عرض مريح */
    }
    .row{display:flex;flex-wrap:wrap;align-items:center;gap:12px}

    label{font-weight:600;color:var(--text);font-size:1.1em}
    select,input[type=number]{background:#0d1430;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:12px 14px;border-radius:14px;outline:none;font-size:16px;transition:.2s}
    select:focus,input[type=number]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,.25)}

    .guess-wrap{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center; /* أهم حاجة */
      flex-wrap:wrap;
    }
    .guess-input{
      font-size:2.5em !important;
      padding:20px 24px !important;
      text-align:center;
      width:200px;
      border-radius:20px !important;
      font-weight:bold;
    }
    
    .btn{cursor:pointer;background:linear-gradient(180deg,var(--accent),#5b21b6);color:white;border:none;padding:12px 16px;border-radius:14px;font-weight:700;letter-spacing:.3px;box-shadow:0 8px 18px rgba(124,58,237,.35);transition:transform .06s ease,filter .2s}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#0d1430;border:1px solid rgba(255,255,255,.08);box-shadow:none}
    .btn.large{font-size:1.3em;padding:16px 24px}

    .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .stat{background:#0d1430;border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px 14px}
    .stat .label{font-size:12px;color:var(--muted)}
    .stat .value{font-size:20px;font-weight:800;margin-top:4px}

    .message{min-height:40px;font-size:18px;text-align:center}
    .hint{color:var(--muted)}
    .message.win{color:var(--success);text-shadow:0 0 14px rgba(34,197,94,.35)}
    .message.lose{color:var(--danger)}

    .range-bar{height:12px;background:#0d1430;border:1px solid rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
    .range-fill{height:100%;width:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}

    .shake{animation:shake .3s linear}
    @keyframes shake{25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}

    /* Confetti Canvas overlays the card */
    #confetti{position:absolute;inset:0;pointer-events:none;mix-blend-mode:screen}

    /* Modal for name input */
    .modal-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      backdrop-filter:blur(5px);
    }
    
    .modal{
      background:var(--card);
      border:1px solid rgba(255,255,255,.1);
      border-radius:20px;
      padding:30px;
      text-align:center;
      max-width:400px;
      width:90%;
      box-shadow:0 25px 50px rgba(0,0,0,.5);
    }
    
    .modal h2{
      color:var(--success);
      font-size:2em;
      margin:0 0 15px 0;
    }
    
    .modal input{
      width:100%;
      font-size:1.3em;
      padding:15px;
      margin:15px 0;
      text-align:center;
    }
    
    .modal-buttons{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:20px;
    }

    /* Leaderboard */
    .leaderboard{
      margin-top:20px;
      width:100%;
      max-width:700px;
    }
    
    .leaderboard-title{
      font-size:1.5em;
      color:var(--accent);
      text-align:center;
      margin-bottom:15px;
      font-weight:bold;
    }
    
    .leaderboard-table{
      width:100%;
      border-collapse:collapse;
      text-align:center;
    }
    
    .leaderboard-table th,
    .leaderboard-table td{
      padding:10px;
      text-align:center;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    
    .leaderboard-table th{
      background:rgba(124,58,237,.2);
      color:var(--text);
      font-weight:bold;
    }
    
    .leaderboard-table tr:hover{
      background:rgba(255,255,255,.05);
    }
    
    .rank-1{color:gold}
    .rank-2{color:silver}
    .rank-3{color:#cd7f32}

    @media (max-width:520px){
      .stats{grid-template-columns:repeat(2,minmax(0,1fr))}
      .hamoda-title{font-size:2.5em}
      .game-subtitle{font-size:1.4em}
      .header-controls{flex-direction:column}
      .guess-input{width:160px !important;font-size:2em !important}
    }
  </style>
</head>
<body>
  <div class="watermark">H</div>
  
  <div class="app">
    <header>
      <h1 class="hamoda-title">HAMODA</h1>
      <div class="game-subtitle">لعبة خمن الرقم</div>
      
      <div class="header-controls">
        <div class="control-group">
          <label for="difficulty">الصعوبة:</label>
          <select id="difficulty" title="اختر مستوى الصعوبة">
            <option value="50">سهل (1–50)</option>
            <option value="100" selected>متوسط (1–100)</option>
            <option value="500">صعب (1–500)</option>
            <option value="1000">أسطوري (1–1000)</option>
          </select>
        </div>
        <button class="btn secondary" id="newGame">لعبة جديدة</button>
      </div>
    </header>

    <main>
      <section class="panel" id="gameCard">
        <canvas id="confetti"></canvas>
        <div class="stats">
          <div class="stat"><div class="label">المجال الحالي</div><div class="value" id="rangeLabel">1 – 100</div></div>
          <div class="stat"><div class="label">عدد المحاولات</div><div class="value" id="tries">0</div></div>
          <div class="stat"><div class="label">أفضل نتيجة</div><div class="value" id="best">—</div></div>
        </div>

        <div class="range-bar" aria-hidden="true"><div class="range-fill" id="rangeFill"></div></div>

        <div class="message hint" id="message">اخمن رقم بين <span id="min">1</span> و <span id="max">100</span>. ✨</div>

        <div class="guess-wrap">
          <input id="guess" class="guess-input" type="number" inputmode="numeric" placeholder="؟" min="1" max="100" />
          <button class="btn large" id="submit">خمن</button>
          <button class="btn secondary" id="hintBtn" title="تلميح">تلميح</button>
          <button class="btn secondary" id="reset">إعادة</button>
        </div>

      </section>

      <section class="panel leaderboard">
        <div class="leaderboard-title">🏆 أفضل 5 لاعبين</div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>المركز</th>
              <th>الاسم</th>
              <th>المحاولات</th>
              <th>الصعوبة</th>
            </tr>
          </thead>
          <tbody id="leaderboard">
            <tr><td colspan="4">لا توجد نتائج بعد</td></tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Name Input Modal -->
  <div class="modal-overlay" id="nameModal">
    <div class="modal">
      <h2>🎉 مبروك!</h2>
      <p>لقد فزت في <span id="modalTries"></span> محاولة!</p>
      <p>أدخل اسمك لحفظ النتيجة:</p>
      <input type="text" id="playerName" placeholder="اكتب اسمك هنا" maxlength="20">
      <div class="modal-buttons">
        <button class="btn" id="saveName">حفظ النتيجة</button>
        <button class="btn secondary" id="skipSave">تخطي</button>
      </div>
    </div>
  </div>

  <script>
    // ======= Game State =======
    const els = {
      difficulty: document.getElementById('difficulty'),
      newGame: document.getElementById('newGame'),
      tries: document.getElementById('tries'),
      best: document.getElementById('best'),
      message: document.getElementById('message'),
      guess: document.getElementById('guess'),
      submit: document.getElementById('submit'),
      reset: document.getElementById('reset'),
      hintBtn: document.getElementById('hintBtn'),
      min: document.getElementById('min'),
      max: document.getElementById('max'),
      rangeLabel: document.getElementById('rangeLabel'),
      rangeFill: document.getElementById('rangeFill'),
      card: document.getElementById('gameCard'),
      confetti: document.getElementById('confetti'),
      nameModal: document.getElementById('nameModal'),
      playerName: document.getElementById('playerName'),
      modalTries: document.getElementById('modalTries'),
      saveName: document.getElementById('saveName'),
      skipSave: document.getElementById('skipSave'),
      leaderboard: document.getElementById('leaderboard')
    };

    const storageKey = 'hamoda-guess-best';
    const leaderboardKey = 'hamoda-leaderboard';
    let secret = 0, tries = 0, lo = 1, hi = +els.difficulty.value, playing = true;

    function rand(n){return Math.floor(Math.random()*n)+1}

    function setRange(min, max){
      lo = min; hi = max;
      els.min.textContent = lo;
      els.max.textContent = hi;
      els.rangeLabel.textContent = `${lo} – ${hi}`;
      els.guess.min = lo; els.guess.max = hi;
      updateRangeFill();
    }

    function NewGame(){
      playing = true;
      tries = 0; els.tries.textContent = tries;
      secret = rand(+els.difficulty.value);
      setRange(1, +els.difficulty.value);
      els.message.className = 'message hint';
      // إعادة رسم النص + إعادة ربط عناصر min/max
      els.message.innerHTML = `اخمن رقم بين <span id="min">${lo}</span> و <span id="max">${hi}</span>. ✨`;
      els.min = document.getElementById('min');
      els.max = document.getElementById('max');
      els.guess.value = '';
      stopConfetti();
      vibrate(15);
    }

    // ======= Leaderboard =======
    function loadLeaderboard(){
      try {
        return JSON.parse(localStorage.getItem(leaderboardKey) || '[]');
      } catch {
        return [];
      }
    }

    function saveLeaderboard(leaderboard){
      localStorage.setItem(leaderboardKey, JSON.stringify(leaderboard));
    }

    function updateLeaderboardDisplay(){
      const leaderboard = loadLeaderboard();
      const tbody = els.leaderboard;
      
      if(leaderboard.length === 0){
        tbody.innerHTML = '<tr><td colspan="4">لا توجد نتائج بعد</td></tr>';
        return;
      }
      
      tbody.innerHTML = leaderboard.map((entry, index) => {
        const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
        const difficultyText = entry.difficulty == 50 ? 'سهل' : 
                              entry.difficulty == 100 ? 'متوسط' : 
                              entry.difficulty == 500 ? 'صعب' : 'أسطوري';
        return `
          <tr>
            <td class="${rankClass}">${index + 1}</td>
            <td>${entry.name}</td>
            <td>${entry.tries}</td>
            <td>${difficultyText}</td>
          </tr>
        `;
      }).join('');
    }

    function addToLeaderboard(name, tries, difficulty){
      const leaderboard = loadLeaderboard();
      leaderboard.push({ name, tries, difficulty, date: Date.now() });
      
      // Sort by tries (ascending), then by difficulty (descending for tie-breaking)
      leaderboard.sort((a, b) => {
        if(a.tries !== b.tries) return a.tries - b.tries;
        return b.difficulty - a.difficulty;
      });
      
      // Keep only top 5
      const topFive = leaderboard.slice(0, 5);
      saveLeaderboard(topFive);
      updateLeaderboardDisplay();
      
      // Update best score display
      if(topFive.length > 0){
        els.best.textContent = topFive[0].tries;
      }
    }

    // ======= Feedback =======
    function updateRangeFill(){
      const width = Math.max(6, (hi-lo+1) / +els.difficulty.value * 100);
      els.rangeFill.style.width = width + '%';
    }

    function showMessage(text, type='hint'){
      els.message.innerHTML = text;
      els.message.className = 'message ' + type;
    }

    function wrongGuessPulse(){
      els.card.classList.remove('shake');
      void els.card.offsetWidth; // reflow
      els.card.classList.add('shake');
      // quick beep
      tone(600, 0.12);
    }

    function onWin(){
      playing = false;
      showMessage(`🎉 مبروك! الرقم هو ${secret}`, 'win');
      confettiBlast();
      victoryJingle();
      vibrate([50, 40, 50]);
      
      // Show name input modal
      els.modalTries.textContent = tries;
      els.playerName.value = '';
      els.nameModal.style.display = 'flex';
      setTimeout(() => els.playerName.focus(), 100);
    }

    function giveHint(){
      if(!playing) return;
      const diff = Math.abs(secret - (+els.guess.value || 0));
      if(!els.guess.value){ showMessage('اكتب رقم أولاً عشان أقدر أساعدك 😉'); return; }
      if(diff === 0){ onWin(); return; }
      const hot = diff <= Math.ceil((hi-lo+1)/10);
      const msg = hot ? 'سخن جداً 🔥' : (diff <= Math.ceil((hi-lo+1)/5) ? 'سخن 🔥' : 'ساقع ❄️');
      showMessage(`${(+els.guess.value < secret ? 'أعلى' : 'أقل')} • انت ${msg}`);
      tone(hot ? 800 : 300, 0.08);
    }

    // ======= Audio (Web Audio API) =======
    let audioCtx;
    function ensureAudio(){if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();}
    function tone(freq, dur=0.1){
      ensureAudio();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=freq; g.gain.value=0.0001;
      o.connect(g).connect(audioCtx.destination);
      o.start();
      const now = audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.15, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.00001, now+dur);
      o.stop(now+dur);
    }
    function victoryJingle(){
      ensureAudio();
      const notes=[523.25,659.25,783.99,1046.5]; // C5,E5,G5,C6
      notes.forEach((f,i)=>setTimeout(()=>tone(f,0.12), i*120));
    }

    // ======= Confetti (tiny implementation) =======
    const ctx = els.confetti.getContext('2d');
    let confetti = [], rafId;
    function resizeCanvas(){
      els.confetti.width = els.card.clientWidth;
      els.confetti.height = els.card.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);

    function confettiBlast(){
      resizeCanvas();
      const W = els.confetti.width, H = els.confetti.height;
      confetti = Array.from({length: 140}, ()=>({
        x: Math.random()*W,
        y: -20-Math.random()*H*0.3,
        s: 4+Math.random()*6,
        a: Math.random()*Math.PI*2,
        v: 1.5+Math.random()*2.5,
        w: 0.02+Math.random()*0.06,
      }));
      cancelAnimationFrame(rafId);
      const start=performance.now();
      (function frame(){
        rafId = requestAnimationFrame(frame);
        const t = (performance.now()-start)/1000;
        ctx.clearRect(0,0,W,H);
        for(const p of confetti){
          p.y += p.v*3; 
          p.x += Math.sin(p.a+t*3)*1.8; 
          p.a += p.w;
          if(p.y>H+30) p.y = -20;
          drawPiece(p); // ← كانت خارج اللوب وبتكسر السكربت
        }
      })();
    }
    function drawPiece(p){
      const size = p.s, x=p.x, y=p.y;
      const g = ctx.createLinearGradient(x,y,x+size,y+size);
      g.addColorStop(0,'#7c3aed'); g.addColorStop(1,'#22d3ee');
      ctx.fillStyle = g; ctx.save(); ctx.translate(x,y); ctx.rotate(p.a); ctx.fillRect(-size/2,-size/2,size,size); ctx.restore();
    }
    function stopConfetti(){ cancelAnimationFrame(rafId); if(ctx) ctx.clearRect(0,0,els.confetti.width,els.confetti.height); }

    // ======= Vibration =======
    function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p); }

    // ======= Core Guess Logic =======
    function submitGuess(){
      if(!playing) return;
      const g = +els.guess.value;
      if(!Number.isFinite(g) || g<lo || g>hi){ showMessage(`من فضلك اختر رقم بين ${lo} و ${hi}`); wrongGuessPulse(); return; }
      tries++; els.tries.textContent = tries;
      if(g === secret){ onWin(); return; }
      if(g < secret){ setRange(g+1, hi); showMessage('أعلى ↗️'); }
      else { setRange(lo, g-1); showMessage('أقل ↘️'); }
      wrongGuessPulse();
    }

    // ======= Modal Events =======
    els.saveName.addEventListener('click', () => {
      const name = els.playerName.value.trim();
      if(name) {
        addToLeaderboard(name, tries, +els.difficulty.value);
        els.nameModal.style.display = 'none';
      } else {
        els.playerName.focus();
        tone(400, 0.1);
      }
    });

    els.skipSave.addEventListener('click', () => {
      els.nameModal.style.display = 'none';
    });

    els.playerName.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') {
        els.saveName.click();
      }
    });

    // Close modal when clicking outside
    els.nameModal.addEventListener('click', (e) => {
      if(e.target === els.nameModal) {
        els.nameModal.style.display = 'none';
      }
    });

    // ======= Events =======
    els.submit.addEventListener('click', submitGuess);
    els.guess.addEventListener('keydown', e=>{ if(e.key==='Enter'){ submitGuess(); } });
    els.reset.addEventListener('click', ()=>{ els.guess.value=''; showMessage('تم مسح الإدخال. جرّب تاني!'); tone(420,0.07); vibrate(10); });
    els.hintBtn.addEventListener('click', giveHint);
    els.difficulty.addEventListener('change', NewGame);
    els.newGame.addEventListener('click', NewGame);

    // ======= Init =======
    (function init(){
      updateLeaderboardDisplay();
      const leaderboard = loadLeaderboard();
      if(leaderboard.length > 0){
        els.best.textContent = leaderboard[0].tries;
      }
      NewGame();
    })();
  </script>
</body>
  </html>
